{% extends 'base.html' %}
{% load static %}

{% block title %}Bug Reports - Admin Panel{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="{% static 'styles/approvals.css' %}">
<style>
    /* Specific styles for bug report table items */
    .priority-badge { padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 0.75rem; text-transform: uppercase; }
    .priority-high { background: #fee2e2; color: #991b1b; }
    .priority-medium { background: #fef3c7; color: #92400e; }
    .priority-low { background: #d1fae5; color: #065f46; }
    
    .status-select { padding: 6px; border-radius: 6px; border: 1px solid #ddd; background: white; }
    .notes-input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; margin-top: 5px; font-size: 0.9rem; }
    .bug-desc { max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #666; font-size: 0.9rem; }
    .bug-desc.expanded { white-space: normal; }
</style>
{% endblock %}

{% block content %}
<div class="approvals-container">
    <div class="page-header">
        <h1>Bug Reports</h1>
        <p>Manage and track reported issues from users</p>
    </div>

    {% if messages %}
    <div class="messages-container">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}" role="alert">
            <span>{{ message }}</span>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="stats-bar">
        <div class="stat-card">
            <div class="stat-icon pending" style="background: #e0f2fe; color: #0369a1;">‚ö†Ô∏è</div>
            <div class="stat-content">
                <h3>Open Issues</h3>
                <p>{{ open_count }}</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="background: #fee2e2; color: #991b1b;">üî•</div>
            <div class="stat-content">
                <h3>High Priority</h3>
                <p>{{ high_priority_count }}</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon approved">‚úÖ</div>
            <div class="stat-content">
                <h3>Resolved</h3>
                <p>{{ resolved_count }}</p>
            </div>
        </div>
    </div>

    <div class="approvals-section">
        <div class="section-header">
            <h2>Recent Reports</h2>
        </div>

        {% if bugs %}
        <table class="users-table">
            <thead>
                <tr>
                    <th>ID & Date</th>
                    <th>Reporter / Desk</th>
                    <th>Issue</th>
                    <th>Priority</th>
                    <th>Status & Notes</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for bug in bugs %}
                <tr style="vertical-align: top;">
                    <td>
                        <span style="font-weight: bold; color: #327AD9;">#{{ bug.id }}</span><br>
                        <span style="font-size: 0.8rem; color: #888;">{{ bug.created_at|date:"M d, H:i" }}</span>
                    </td>
                    <td>
                        <div class="user-info">
                            <div class="user-details">
                                <div class="username">@{{ bug.user.username }}</div>
                                <div class="fullname" style="font-family: monospace;">{{ bug.desk_id }}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div style="font-weight: 600; margin-bottom: 4px;">{{ bug.title }}</div>
                        <div class="bug-desc" onclick="this.classList.toggle('expanded')" style="cursor: pointer;" title="Click to expand">
                            {{ bug.description }}
                        </div>
                    </td>
                    <td>
                        <span class="priority-badge priority-{{ bug.priority }}">{{ bug.get_priority_display }}</span>
                    </td>
                    <form method="POST" action="{% url 'update_bug_status' %}">
                        {% csrf_token %}
                        <input type="hidden" name="bug_id" value="{{ bug.id }}">
                        <td style="min-width: 200px;">
                            <select name="status" class="status-select" onchange="this.style.borderColor = '#327AD9'">
                                {% for val, label in bug.STATUS_CHOICES %}
                                <option value="{{ val }}" {% if bug.status == val %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                            <textarea name="admin_notes" class="notes-input" rows="2" placeholder="Add admin notes...">{{ bug.admin_notes|default:"" }}</textarea>
                        </td>
                        <td>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <button type="submit" class="btn-action btn-approve" style="background: #327AD9;">
                                    Save
                                </button>

                                {% if bug.status == 'resolved' or bug.status == 'closed' %}
                                    <button type="submit" 
                                        class="btn-action btn-decline" 
                                        style="padding: 8px 12px; font-size: 14px;" 
                                        formaction="{% url 'delete_bug' %}"
                                        onclick="return confirm('Are you sure you want to delete this bug report permanently?');"
                                        title="Delete Report">
                                        ‚úï
                                    </button>
                                {% endif %}
                            </div>
                        </td>
                    </form>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state">
            <h3>No bugs reported!</h3>
            <p>Great job keeping the system stable.</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
{% extends 'base.html' %}
{% load static %}

{% block title %}Home{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'styles/main.css' %}">
<link rel="stylesheet" href="{% static 'styles/register.css' %}">
{% endblock %}

{% block content %}

<div class="side-panel">
  <h3>Control Panel</h3>
  
  <div id="deskLoadingOverlay" class="loading-overlay">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p>Adjusting Desk...</p>
  </div>

  {% if request.session.user_id %}
  <div class="panel-section view-section">
    <h4>Switch Room/Floor</h4>
    <button class="view-btn" data-view="overview">Overview</button>
  </div>
  
  <div id="reservation-section">
    <h4>Desk Reservation</h4>
    <p id="selectedDesk">No desk selected</p>
    <div id="statusMessage" class="status-message" aria-live="polite" role="status" style="display:none;"></div>

    <div id="reservationActions" style="display:none; margin-bottom:45px;">
      <form id="pairForm" method="POST" action="{% url 'pair_desk' %}">
        {% csrf_token %}
        <input type="hidden" name="desk_id" id="pairDeskId">
        <button type="submit" id="pairBtn">Pair (Now)</button>
      </form>

      <form id="unpairForm" method="POST" action="{% url 'unpair_desk' %}">
        {% csrf_token %}
        <button type="submit" id="unpairBtn" disabled>Unpair</button>
      </form>

      <button id="showBooking">Book for Later</button>

      <div id="bookingForm" style="display:none; margin-top:15px; margin-bottom:15px;">
        <label for="bookStart">Start:</label>
        <input type="datetime-local" id="bookStart">

        <label for="bookEnd">End:</label>
        <input type="datetime-local" id="bookEnd">

        <button id="bookBtn">Book</button>
        <button id="cancelBooking">Cancel</button>
      </div>
    </div>
  </div>

  <div id="desk-controls" style="display: none;">
    <div class="panel-section">
      <label for="heightSlider">Desk Height: <span id="heightValue">100</span> cm</label>
      <input type="range" id="heightSlider" min="50" max="160" value="65" step="1">
    </div>

    <div class="panel-section">
      <h4>Quick Profiles</h4>
      <button class="profile-btn" data-height="{{ rec_sit }}">Sitting ({{ rec_sit }} cm)</button>
      <button class="profile-btn" data-height="{{ rec_stand }}">Standing ({{ rec_stand }} cm)</button>
    </div>
    <div class="panel-section">
      <button id="reportBugBtn" class="report-bug-btn">Report Bug</button>
    </div>
  </div>

  <div class="panel-section">
    <label>
      <input type="checkbox" id="toggleHealth" checked>
      Show Health Recommendations
    </label>
  </div>
  {% endif %}
</div>

<!-- Main content area - shows ONE room at a time, filtered by selection -->
<div id="main-content">
  {% include 'partials/desks.html' with rooms=rooms %}
</div>

<div id="healthPopup" class="health-popup">
  <div class="popup-header">
    <h4 class="popup-title">üí° Health Recommendation</h4>
  </div>
  <p id="healthMessage">üí° Health tip will appear here</p>
  <div class="popup-buttons">
    <button id="acceptBtn">Accept</button>
    <button id="ignoreBtn">Ignore</button>
  </div>
</div>

<div class="modal fade" id="moveConfirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Movement</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to move the desk to <strong id="confirmHeightVal"></strong> cm?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirmMoveBtn">Move Desk</button>
      </div>
    </div>
  </div>
</div>

<div class="register-overlay" id="bugReportModal" style="display: none;">
  <div class="register-container" style="max-width: 900px;">
    
    <button class="close-modal" id="closeBugModal" aria-label="Close modal">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
    </button>

    <div class="register-info">
      <div class="logo-section">
        <div class="logo-icon">
          <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="8" y="9" width="8" height="12" rx="4" />
            <path d="M12 9V6" />
            <path d="M7 13h-3" />
            <path d="M7 17h-3" />
            <path d="M20 13h-3" />
            <path d="M20 17h-3" />
            <path d="M6 6l3 3" />
            <path d="M18 6l-3 3" />
          </svg>
        </div>
        <h1 class="brand-title">Report a Bug</h1>
        <p class="brand-subtitle">Describe the issue with your desk</p>
      </div>
      
      <div class="info-features">
        <div class="feature-item">
          <span class="feature-icon">üõ†Ô∏è</span>
          <div class="feature-text">
            <h3>Help Us Improve</h3>
            <p>Your feedback makes the system better</p>
          </div>
        </div>
        <div class="feature-item">
          <span class="feature-icon">üìå</span>
          <div class="feature-text">
            <h3>Be Specific</h3>
            <p>Details help us fix issues faster</p>
          </div>
        </div>
      </div>
      
      <div class="info-footer">
        <p class="copyright">¬© 2025 SDU Engineering Project</p>
      </div>
    </div>

    <div class="register-form-section">
      <div class="form-wrapper">
        <div class="form-header">
          <h2>Issue Details</h2>
          <p>Please fill out the form below</p>
        </div>

        <form id="bugReportForm" class="register-form">
          <div class="form-group">
            <label class="form-label">Issue Title</label>
            <div class="input-wrapper">
              <input type="text" id="bugTitle" required placeholder="e.g., Desk controls not responding">
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Description</label>
            <div class="input-wrapper">
              <textarea id="bugDescription" required rows="4" 
                        style="width: 100%; padding: 12px; border: 2px solid #e0e4e8; border-radius: 12px; resize: vertical; min-height: 100px;" 
                        placeholder="Please describe what happened..."></textarea>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Priority</label>
            <div class="input-wrapper select-wrapper">
              <select id="bugPriority">
                  <option value="low">Low - Minor annoyance</option>
                  <option value="medium" selected>Medium - Feature broken</option>
                  <option value="high">High - Desk unusable</option>
              </select>
            </div>
          </div>

          <button type="submit" class="btn-register" style="background: linear-gradient(135deg, #dc3545, #c82333); margin-top: 10px;">
            <span>Submit Report</span>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="22" y1="2" x2="11" y2="13"></line>
              <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
  const USER_HEIGHT_CM = Number("{{ user_height|default:'176' }}") || 176;
  const INITIAL_DESK_ID = "{{ active_desk_id|default:'' }}";
</script>

<script>
// ‚úÖ FIXED: Load desks filtered by BOTH room AND floor
async function loadDesksForRoom() {
  const selectedRoom = sessionStorage.getItem("lastDeskRoom") || "A";
  const selectedFloor = sessionStorage.getItem("lastDeskFloor") || "Floor 1";
  
  try {
    const response = await fetch(`/api/desks/`, {
      method: 'GET',
      credentials: 'same-origin',
      headers: { 'Accept': 'application/json' }
    });
    
    if (!response.ok) {
      console.error('[index] Failed to fetch desks:', response.status);
      updateMainContent([], selectedFloor, selectedRoom);
      return {};
    }
    
    const allDesks = await response.json();
    
    // Filter desks for the selected room AND floor
    const filteredDesks = allDesks.filter(desk => 
      (desk.floor || 'Floor 1') === selectedFloor && 
      (desk.room || 'A') === selectedRoom
    );
    
    updateMainContent(filteredDesks, selectedFloor, selectedRoom);
    
    return { filteredDesks, selectedFloor, selectedRoom };
  } catch (err) {
    console.error('[index] Error loading desks:', err);
    updateMainContent([], selectedFloor, selectedRoom);
    return {};
  }
}

// ‚úÖ FIXED: Render desks to the DOM (only updates if content changed)
function updateMainContent(desksData, floor, room) {
  const mainContent = document.getElementById('main-content');
  
  let html = `
    <div class="grid-container">
      <img src="{% static 'Assets/este.jpg' %}" class="background-image" alt="Background">
      <div class="room-wrapper" id="room-${room}">
        <h3 style="position: relative; z-index: 10;">${floor} - Room ${room}</h3>
        <div class="room-block">
  `;
  
  if (desksData.length === 0) {
    html += `<p style="text-align: center; color: #999; padding: 40px; grid-column: 1/-1;">No desks in this room</p>`;
  } else {
    desksData.forEach((desk, index) => {
      html += `
        <button class="btn btn${index + 1}"
          data-desk-id="${desk.mac}"
          data-desk-number="${index + 1}">
          ${index + 1}
        </button>
      `;
    });
  }
  
  html += `
        </div>
      </div>
    </div>
  `;
  
  // ‚úÖ Only update if content actually changed
  if (mainContent.innerHTML !== html) {
    mainContent.innerHTML = html;
    document.dispatchEvent(new Event("overviewLoaded"));
  }
}

// ‚úÖ Listen for room selection changes
document.addEventListener('roomSelected', async (e) => {
  console.log('[index] Room selected event received:', e.detail);
  await loadDesksForRoom();
});

// Initial load on page load
document.addEventListener('DOMContentLoaded', async () => {
  console.log('[index] Page loaded, loading desks for selected room...');
  await loadDesksForRoom();
  document.dispatchEvent(new Event("overviewLoaded"));
});

// ‚úÖ REMOVED: Interval-based refresh (causes blinking)
// Auto-refresh only happens when needed via roomSelected event
</script>

<script type="module" src="{% static 'script/desk.js' %}"></script>
<script src="{% static 'script/overview.js' %}"></script>
{% endblock %}
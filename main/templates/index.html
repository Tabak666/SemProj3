{% extends 'base.html' %}
{% load static %}

{% block title %}Home{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'styles/main.css' %}">
{% endblock %}

{% block content %}

<div class="side-panel">
  <h3>Control Panel</h3>
  
  <div id="deskLoadingOverlay" class="loading-overlay">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p>Adjusting Desk...</p>
  </div>

  {% if request.session.user_id %}
  <div class="panel-section view-section">
    <h4>Views</h4>
    <button class="view-btn" data-view="desks">Desks</button>
    <button class="view-btn" data-view="overview">Overview</button>
  </div>
    <div id="reservation-section">
    <h4>Desk Reservation</h4>
    <p id="selectedDesk">No desk selected</p>
    <div id="statusMessage" class="status-message" aria-live="polite" role="status" style="display:none;"></div>

    <div id="reservationActions" style="display:none; margin-bottom:45px;">
      <form id="pairForm" method="POST" action="{% url 'pair_desk' %}">
      {% csrf_token %}
          <input type="hidden" name="desk_id" id="pairDeskId">
          <button type="submit" id="pairBtn">Pair (Now)</button>
      </form>

      <form id="unpairForm" method="POST" action="{% url 'unpair_desk' %}">
          {% csrf_token %}
          <button type="submit" id="unpairBtn" disabled>Unpair</button>
      </form>

      <button id="showBooking">Book for Later</button>

      <div id="bookingForm" style="display:none; margin-top:15px; margin-bottom:15px;">
        <label for="bookStart">Start:</label>
        <input type="datetime-local" id="bookStart">

        <label for="bookEnd">End:</label>
        <input type="datetime-local" id="bookEnd">

        <button id="bookBtn">Book</button>
        <button id="cancelBooking">Cancel</button>
      </div>
    </div>
  </div>

  <div id="desk-controls" style="display: none;">
      <div class="panel-section">
        <label for="heightSlider">Desk Height: <span id="heightValue">100</span> cm</label>
        <input type="range" id="heightSlider" min="50" max="160" value="65" step="1">
      </div>

      <div class="panel-section">
        <h4>Quick Profiles</h4>
        <button class="profile-btn" data-height="{{ rec_sit }}">Sitting ({{ rec_sit }} cm)</button>
        <button class="profile-btn" data-height="{{ rec_stand }}">Standing ({{ rec_stand }} cm)</button>
      </div>
      <div class="panel-section">
        <button id="reportBugBtn" class="report-bug-btn">Report Bug</button>
      </div>
  </div>

  <div class="panel-section">
    <label>
      <input type="checkbox" id="toggleHealth" checked>
      Show Health Recommendations
    </label>
  </div>
</div>
{% endif %}
<div id="main-content">
  {% include 'partials/desks.html' with rooms=rooms %}
</div>

<div id="healthPopup" class="health-popup">
  <div class="popup-header">
    <h4 class="popup-title">ðŸ’¡ Health Recommendation</h4>
  </div>
  <p id="healthMessage">ðŸ’¡ Health tip will appear here</p>
  <div class="popup-buttons">
    <button id="acceptBtn">Accept</button>
    <button id="ignoreBtn">Ignore</button>
  </div>
</div>

<div class="modal fade" id="moveConfirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Movement</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to move the desk to <strong id="confirmHeightVal"></strong> cm?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirmMoveBtn">Move Desk</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
  const USER_HEIGHT_CM = {{ user_height|default:"176" }};
  const INITIAL_DESK_ID = "{{ active_desk_id|default:'' }}";
</script>
<script type="module" src="{% static 'script/desk.js' %}"></script>

<script src="{% static 'script/overview.js' %}"></script>
{% endblock %}